<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Daily Picks AI News</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Newsreader:wght@400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root {
      --primary: #3B82F6;
      --primary-hover: #2563EB;
      --secondary: #60A5FA;
      --cta: #F97316;
      --background: #F8FAFC;
      --surface: #FFFFFF;
      --text: #1E293B;
      --text-muted: #64748B;
      --border: #E2E8F0;
      --code-bg: #F1F5F9;
      --max-width: 800px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --background: #0F172A;
        --surface: #1E293B;
        --text: #F1F5F9;
        --text-muted: #94A3B8;
        --border: #334155;
        --code-bg: #334155;
      }
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    @media (prefers-reduced-motion: reduce) {
      html {
        scroll-behavior: auto;
      }
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        transition-duration: 0.01ms !important;
      }
    }

    body {
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 16px;
      line-height: 1.7;
      color: var(--text);
      background-color: var(--background);
      min-height: 100vh;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 1rem 1.5rem;
    }

    .header-content {
      max-width: var(--max-width);
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }

    .logo {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: color 200ms ease;
    }

    .logo:hover {
      color: var(--primary);
    }

    .logo svg {
      width: 24px;
      height: 24px;
      color: var(--primary);
    }

    .file-selector {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .file-selector label {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    .file-selector select {
      padding: 0.5rem 2rem 0.5rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: border-color 200ms ease;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
    }

    .file-selector select:hover,
    .file-selector select:focus {
      border-color: var(--primary);
      outline: none;
    }

    .nav-btn {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
      transition: border-color 200ms ease, opacity 200ms ease;
      line-height: 1;
    }

    .nav-btn:hover:not(:disabled) {
      border-color: var(--primary);
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    main {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 2rem 1.5rem 4rem;
    }

    .loading,
    .error,
    .empty {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }

    .error {
      color: #EF4444;
    }

    .error svg,
    .empty svg {
      width: 48px;
      height: 48px;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .content {
      animation: fadeIn 300ms ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .content h1 {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 1.5rem;
      line-height: 1.3;
      color: var(--text);
    }

    .content h2 {
      font-family: 'Newsreader', Georgia, serif;
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2.5rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid var(--primary);
      color: var(--text);
    }

    .content h3 {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 0.75rem;
      color: var(--text);
    }

    .content h4 {
      font-size: 1.1rem;
      font-weight: 500;
      margin: 1.5rem 0 0.5rem;
      color: var(--text);
    }

    .content p {
      margin-bottom: 1rem;
    }

    .content a {
      color: var(--primary);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 200ms ease;
    }

    .content a:hover {
      border-bottom-color: var(--primary);
    }

    .content ul,
    .content ol {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    .content li {
      margin-bottom: 0.5rem;
    }

    .content li > ul,
    .content li > ol {
      margin: 0.5rem 0;
    }

    .content blockquote {
      margin: 1.5rem 0;
      padding: 1rem 1.5rem;
      border-left: 4px solid var(--primary);
      background: var(--code-bg);
      border-radius: 0 6px 6px 0;
      color: var(--text-muted);
      font-style: italic;
    }

    .content code {
      font-family: 'SF Mono', Menlo, Monaco, monospace;
      font-size: 0.875em;
      padding: 0.2em 0.4em;
      background: var(--code-bg);
      border-radius: 4px;
    }

    .content pre {
      margin: 1.5rem 0;
      padding: 1rem;
      background: var(--code-bg);
      border-radius: 8px;
      overflow-x: auto;
    }

    .content pre code {
      padding: 0;
      background: none;
    }

    .content hr {
      margin: 2rem 0;
      border: none;
      border-top: 1px solid var(--border);
    }

    .content table {
      width: 100%;
      margin: 1.5rem 0;
      border-collapse: collapse;
      font-size: 0.9375rem;
    }

    .content th,
    .content td {
      padding: 0.75rem 1rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    .content th {
      font-weight: 600;
      background: var(--code-bg);
    }

    .content img {
      max-width: 100%;
      height: auto;
      border-radius: 8px;
      margin: 1rem 0;
    }

    .content strong {
      font-weight: 600;
    }

    footer {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 2rem 1.5rem;
      border-top: 1px solid var(--border);
      text-align: center;
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
      cursor: pointer;
      transition: color 200ms ease;
    }

    footer a:hover {
      color: var(--primary-hover);
    }

    @media (max-width: 640px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .content h1 {
        font-size: 1.5rem;
      }

      .content h2 {
        font-size: 1.25rem;
      }
    }

    /* TTS æ’­æ”¾æ§åˆ¶æ¨£å¼ */
    .tts-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .tts-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.375rem;
      padding: 0.5rem 0.875rem;
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      border: none;
      border-radius: 9999px;
      cursor: pointer;
      transition: all 200ms ease;
      white-space: nowrap;
    }

    .tts-btn-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      color: white;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
    }

    .tts-btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    .tts-btn-primary:active {
      transform: translateY(0);
    }

    .tts-btn-primary.playing {
      background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
    }

    .tts-btn-primary.playing:hover {
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .tts-btn-icon {
      padding: 0.5rem;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .tts-btn-icon:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .tts-btn svg {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .tts-checkbox {
      display: flex;
      align-items: center;
      gap: 0.375rem;
      font-size: 0.8125rem;
      color: var(--text-muted);
      cursor: pointer;
      user-select: none;
    }

    .tts-checkbox input {
      width: 14px;
      height: 14px;
      accent-color: var(--primary);
      cursor: pointer;
    }

    /* å–®é …æ’­æ”¾æŒ‰éˆ• */
    .content h2 {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .item-play-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      padding: 0;
      border: none;
      border-radius: 50%;
      background: var(--code-bg);
      color: var(--text-muted);
      cursor: pointer;
      transition: all 200ms ease;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .item-play-btn:hover {
      background: var(--primary);
      color: white;
      opacity: 1;
      transform: scale(1.1);
    }

    .item-play-btn.playing {
      background: #EF4444;
      color: white;
      opacity: 1;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .item-play-btn svg {
      width: 14px;
      height: 14px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* æ’­æ”¾ä¸­çš„æ–°èé …ç›®é«˜äº® */
    .news-section.playing {
      position: relative;
    }

    .news-section.playing::before {
      content: '';
      position: absolute;
      left: -1rem;
      top: 0;
      bottom: 0;
      width: 3px;
      background: var(--primary);
      border-radius: 2px;
    }

    /* è¨­å®š Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 200ms ease;
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
      transform: translateY(20px);
      transition: transform 200ms ease;
    }

    .modal-overlay.open .modal {
      transform: translateY(0);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .modal-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text);
    }

    .modal-close {
      padding: 0.25rem;
      border: none;
      background: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 4px;
      transition: color 200ms ease;
    }

    .modal-close:hover {
      color: var(--text);
    }

    .modal-close svg {
      width: 20px;
      height: 20px;
    }

    .modal-body {
      margin-bottom: 1.5rem;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-label {
      display: block;
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 0.375rem;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    .form-input {
      width: 100%;
      padding: 0.625rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--background);
      color: var(--text);
      transition: border-color 200ms ease;
    }

    .form-input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .form-input::placeholder {
      color: var(--text-muted);
    }

    .form-select {
      width: 100%;
      padding: 0.625rem 2rem 0.625rem 0.75rem;
      font-size: 0.875rem;
      font-family: inherit;
      border: 1px solid var(--border);
      border-radius: 6px;
      background: var(--background);
      color: var(--text);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.5rem center;
      background-size: 1rem;
    }

    .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .modal-footer {
      display: flex;
      gap: 0.75rem;
      justify-content: flex-end;
    }

    .btn {
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      font-family: inherit;
      font-weight: 500;
      border-radius: 6px;
      cursor: pointer;
      transition: all 200ms ease;
    }

    .btn-secondary {
      background: var(--code-bg);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      border-color: var(--primary);
    }

    .btn-primary {
      background: var(--primary);
      border: 1px solid var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
    }

    /* TTS ç‹€æ…‹æŒ‡ç¤º */
    .tts-status {
      font-size: 0.75rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .tts-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }

    .tts-status-dot.azure {
      background: #10B981;
    }

    .tts-status-dot.google {
      background: #4285F4;
    }

    .tts-status-dot.gemini {
      background: #8B5CF6;
    }

    .tts-status-dot.fish {
      background: #06B6D4;
    }

    .tts-status-dot.web {
      background: #F59E0B;
    }

    /* è‡ªå‹•æ’­æ”¾å•Ÿå‹•è¦†è“‹å±¤ */
    .autoplay-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(8px);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: all 300ms ease;
      cursor: pointer;
    }

    .autoplay-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .autoplay-overlay-content {
      text-align: center;
      color: white;
      animation: float 2s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .autoplay-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 1.5rem;
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-hover) 100%);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 32px rgba(59, 130, 246, 0.4);
    }

    .autoplay-icon svg {
      width: 36px;
      height: 36px;
      color: white;
      margin-left: 4px;
    }

    .autoplay-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .autoplay-hint {
      font-size: 0.875rem;
      color: var(--text-muted);
    }

    @media (max-width: 640px) {
      .tts-controls {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }

      .tts-btn span {
        display: none;
      }

      .tts-btn svg {
        width: 18px;
        height: 18px;
      }

      .tts-checkbox span {
        display: none;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <a href="index.html" class="logo">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 0 1-2.25 2.25M16.5 7.5V18a2.25 2.25 0 0 0 2.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 0 0 2.25 2.25h13.5M6 7.5h3v3H6v-3Z" />
        </svg>
        Daily Picks AI News
      </a>
      <div class="file-selector">
        <button id="prev-btn" class="nav-btn" aria-label="ä¸Šä¸€ç¯‡" disabled>â†</button>
        <select id="month-select" aria-label="é¸æ“‡æœˆä»½"></select>
        <select id="day-select" aria-label="é¸æ“‡æ—¥æœŸ"></select>
        <button id="next-btn" class="nav-btn" aria-label="ä¸‹ä¸€ç¯‡" disabled>â†’</button>
      </div>
      <div class="tts-controls">
        <button id="play-all-btn" class="tts-btn tts-btn-primary" aria-label="å…¨éƒ¨æ’­æ”¾">
          <svg id="play-all-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <span>å…¨éƒ¨æ’­æ”¾</span>
        </button>
        <label class="tts-checkbox">
          <input type="checkbox" id="auto-play-checkbox">
          <span>è‡ªå‹•æ’­æ”¾</span>
        </label>
        <button id="tts-settings-btn" class="tts-btn tts-btn-icon" aria-label="èªéŸ³è¨­å®š">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.325.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.241-.438.613-.43.992a7.723 7.723 0 0 1 0 .255c-.008.378.137.75.43.991l1.004.827c.424.35.534.955.26 1.43l-1.298 2.247a1.125 1.125 0 0 1-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.47 6.47 0 0 1-.22.128c-.331.183-.581.495-.644.869l-.213 1.281c-.09.543-.56.94-1.11.94h-2.594c-.55 0-1.019-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 0 1-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 0 1-1.369-.49l-1.297-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.43-.991a6.932 6.932 0 0 1 0-.255c.007-.38-.138-.751-.43-.992l-1.004-.827a1.125 1.125 0 0 1-.26-1.43l1.297-2.247a1.125 1.125 0 0 1 1.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.086.22-.128.332-.183.582-.495.644-.869l.214-1.28Z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
          </svg>
        </button>
        <div class="tts-status">
          <span class="tts-status-dot" id="tts-status-dot"></span>
          <span id="tts-status-text">Web Speech</span>
        </div>
      </div>
    </div>
  </header>

  <main id="main">
    <div class="empty">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
      </svg>
      <p>è«‹é¸æ“‡å ±å‘Šæª”æ¡ˆ</p>
    </div>
  </main>

  <footer>
    <p>Powered by <a href="https://github.com/yelban/erduo-skills.TW">å¹æ°´ä¹œé‡</a></p>
  </footer>

  <!-- è‡ªå‹•æ’­æ”¾å•Ÿå‹•è¦†è“‹å±¤ -->
  <div id="autoplay-overlay" class="autoplay-overlay">
    <div class="autoplay-overlay-content">
      <div class="autoplay-icon">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
          <path d="M8 5v14l11-7z"/>
        </svg>
      </div>
      <div class="autoplay-title">é»æ“Šé–‹å§‹æ’­æ”¾</div>
      <div class="autoplay-hint">ç€è¦½å™¨éœ€è¦äº’å‹•æ‰èƒ½æ’­æ”¾éŸ³è¨Š</div>
    </div>
  </div>

  <!-- TTS è¨­å®š Modal -->
  <div id="tts-settings-modal" class="modal-overlay">
    <div class="modal" role="dialog" aria-labelledby="modal-title">
      <div class="modal-header">
        <h3 class="modal-title" id="modal-title">èªéŸ³è¨­å®š</h3>
        <button id="modal-close-btn" class="modal-close" aria-label="é—œé–‰">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label" for="tts-engine-select">èªéŸ³å¼•æ“</label>
          <select id="tts-engine-select" class="form-select">
            <option value="web">Web Speech APIï¼ˆå…è²»ï¼‰</option>
            <option value="azure">Azure TTSï¼ˆé«˜å“è³ªï¼‰</option>
            <option value="google">Google Cloud TTSï¼ˆå…è²»é¡åº¦å¤šï¼‰</option>
            <option value="gemini">Gemini TTSï¼ˆæœ€è‡ªç„¶ï¼‰</option>
            <option value="fish">Fish Audioï¼ˆå°ç£è…”ï¼‰</option>
          </select>
          <p class="form-hint" id="engine-hint">Gemini TTS æœ€è‡ªç„¶ï¼Œå¯ç”¨æç¤ºæ§åˆ¶èªèª¿</p>
        </div>
        <div id="azure-settings" class="form-group" style="display: none;">
          <label class="form-label" for="azure-key-input">Azure API Key</label>
          <input type="password" id="azure-key-input" class="form-input" placeholder="è¼¸å…¥æ‚¨çš„ Azure Speech API Key">
          <p class="form-hint">å¾ Azure Portal å–å¾— Speech æœå‹™çš„ API Keyï¼ˆå…è²» 50 è¬å­—/æœˆï¼‰</p>
        </div>
        <div id="azure-region-settings" class="form-group" style="display: none;">
          <label class="form-label" for="azure-region-input">Azure å€åŸŸ</label>
          <input type="text" id="azure-region-input" class="form-input" placeholder="eastasia" value="eastasia">
          <p class="form-hint">ä¾‹å¦‚ï¼šeastasiaã€southeastasiaã€westus</p>
        </div>
        <div id="azure-proxy-settings" class="form-group" style="display: none;">
          <label class="form-label" for="azure-proxy-input">ä»£ç† URLï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="azure-proxy-input" class="form-input" placeholder="https://azure-tts.twampd.workers.dev">
          <p class="form-hint">ä½¿ç”¨ä»£ç†æ™‚ç„¡éœ€è¼¸å…¥ API Keyï¼ŒKey ç”±ä»£ç†ä¼ºæœå™¨ç®¡ç†</p>
        </div>
        <div id="google-settings" class="form-group" style="display: none;">
          <label class="form-label" for="google-key-input">Google Cloud API Key</label>
          <input type="password" id="google-key-input" class="form-input" placeholder="è¼¸å…¥æ‚¨çš„ Google Cloud API Key">
          <p class="form-hint">å¾ Google Cloud Console å–å¾— Text-to-Speech API Keyï¼ˆå…è²» 100 è¬å­—/æœˆï¼‰</p>
        </div>
        <div id="gemini-settings" class="form-group" style="display: none;">
          <label class="form-label" for="gemini-key-input">Gemini API Key</label>
          <input type="password" id="gemini-key-input" class="form-input" placeholder="è¼¸å…¥æ‚¨çš„ Gemini API Key">
          <p class="form-hint">å¾ <a href="https://aistudio.google.com/apikey" target="_blank">AI Studio</a> å–å¾— API Key</p>
        </div>
        <div id="gemini-voice-settings" class="form-group" style="display: none;">
          <label class="form-label" for="gemini-voice-select">èªéŸ³è§’è‰²</label>
          <select id="gemini-voice-select" class="form-select">
            <option value="Kore">Koreï¼ˆå¥³è²ï¼Œæº«æš–ï¼‰</option>
            <option value="Charon">Charonï¼ˆç”·è²ï¼Œæ²‰ç©©ï¼‰</option>
            <option value="Fenrir">Fenrirï¼ˆç”·è²ï¼Œæœ‰åŠ›ï¼‰</option>
            <option value="Aoede">Aoedeï¼ˆå¥³è²ï¼Œæ¸…äº®ï¼‰</option>
            <option value="Puck">Puckï¼ˆä¸­æ€§ï¼Œæ´»æ½‘ï¼‰</option>
            <option value="Zephyr">Zephyrï¼ˆä¸­æ€§ï¼Œè¼•æŸ”ï¼‰</option>
          </select>
        </div>
        <div id="fish-settings" class="form-group" style="display: none;">
          <label class="form-label" for="fish-key-input">Fish Audio API Key</label>
          <input type="password" id="fish-key-input" class="form-input" placeholder="è¼¸å…¥æ‚¨çš„ Fish Audio API Key">
          <p class="form-hint">å¾ <a href="https://fish.audio/zh-TW/" target="_blank">Fish Audio</a> å–å¾— API Key</p>
        </div>
        <div id="fish-voice-settings" class="form-group" style="display: none;">
          <label class="form-label" for="fish-voice-input">èªéŸ³æ¨¡å‹ ID</label>
          <input type="text" id="fish-voice-input" class="form-input" placeholder="è¼¸å…¥èªéŸ³æ¨¡å‹ IDï¼ˆå¦‚ï¼šå°ç£å¥³ç”Ÿï¼‰">
          <p class="form-hint">åœ¨ <a href="https://fish.audio/zh-TW/discover" target="_blank">Fish Audio ç™¼ç¾</a> æœå°‹ã€Œå°ç£ã€æ‰¾åˆ°å–œæ­¡çš„èªéŸ³</p>
        </div>
        <div id="fish-proxy-settings" class="form-group" style="display: none;">
          <label class="form-label" for="fish-proxy-input">ä»£ç† URLï¼ˆé¸å¡«ï¼‰</label>
          <input type="text" id="fish-proxy-input" class="form-input" placeholder="https://fish-tts.twampd.workers.dev">
          <p class="form-hint">ç€è¦½å™¨æœ‰ CORS é™åˆ¶ï¼Œéœ€é€éä»£ç†å‘¼å«ã€‚ç•™ç©ºå‰‡è‡ªå‹•é™ç´šè‡³ Web Speech API</p>
        </div>
        <div class="form-group">
          <label class="form-label" for="speech-rate-select">èªé€Ÿ</label>
          <select id="speech-rate-select" class="form-select">
            <option value="0.8">è¼ƒæ…¢ (0.8x)</option>
            <option value="1" selected>æ­£å¸¸ (1x)</option>
            <option value="1.2">è¼ƒå¿« (1.2x)</option>
            <option value="1.5">å¿«é€Ÿ (1.5x)</option>
          </select>
        </div>
        <div class="form-group">
          <button id="test-tts-btn" class="btn btn-secondary" style="width: 100%;">
            ğŸ”Š æ¸¬è©¦èªéŸ³
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="modal-cancel-btn" class="btn btn-secondary">å–æ¶ˆ</button>
        <button id="modal-save-btn" class="btn btn-primary">å„²å­˜</button>
      </div>
    </div>
  </div>

  <script>
    const main = document.getElementById('main');
    const monthSelect = document.getElementById('month-select');
    const daySelect = document.getElementById('day-select');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');

    // å„²å­˜å ±å‘Šåˆ—è¡¨ä¾›å°èˆªä½¿ç”¨
    let reportsList = [];
    // æŒ‰æœˆä»½åˆ†çµ„çš„å ±å‘Š
    let groupedByMonth = {};

    // Cache-busting åƒæ•¸ï¼ˆæ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡ï¼‰
    const cacheBuster = `?v=${Math.floor(Date.now() / 60000)}`;

    // å¾ç´¢å¼•æª”è¼‰å…¥å ±å‘Šåˆ—è¡¨
    async function detectReports() {
      try {
        const response = await fetch('reports.json' + cacheBuster);
        if (!response.ok) {
          console.warn('ç„¡æ³•è¼‰å…¥ reports.jsonï¼Œå›é€€åˆ°è¼ªè©¢æ¨¡å¼');
          return await detectReportsFallback();
        }
        const data = await response.json();
        return data.reports.map(date => ({
          filename: `${date}-news-report`,
          date: date
        }));
      } catch (e) {
        console.warn('è¼‰å…¥å ±å‘Šç´¢å¼•å¤±æ•—ï¼Œå›é€€åˆ°è¼ªè©¢æ¨¡å¼', e);
        return await detectReportsFallback();
      }
    }

    // å‚™æ´ï¼šè¼ªè©¢æª¢æŸ¥å ±å‘Šï¼ˆåƒ…åœ¨ reports.json ä¸å­˜åœ¨æ™‚ä½¿ç”¨ï¼‰
    async function detectReportsFallback() {
      const today = new Date();
      const reports = [];
      for (let i = 0; i < 7; i++) {  // æ¸›å°‘åˆ° 7 å¤©
        const date = new Date(today);
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        const filename = `${dateStr}-news-report`;
        try {
          const response = await fetch(`${filename}.md` + cacheBuster, { method: 'HEAD' });
          if (response.ok) {
            reports.push({ filename, date: dateStr });
          }
        } catch (e) {}
      }
      return reports;
    }

    // å–å¾—ç•¶å‰é¸ä¸­çš„ filename
    function getCurrentFilename() {
      const month = monthSelect.value;
      const day = daySelect.value;
      if (!month || !day) return null;
      return `${month}-${day}-news-report`;
    }

    // æ ¹æ“šæœˆä»½å¡«å……æ—¥æœŸé¸å–®
    function populateDaySelect(month, selectedDay = null) {
      const days = groupedByMonth[month] || [];

      if (days.length === 0) {
        daySelect.innerHTML = '<option value="">ç„¡å¯ç”¨æ—¥æœŸ</option>';
        return;
      }

      daySelect.innerHTML = days.map(r => {
        const day = r.date.slice(8, 10); // "DD"
        return `<option value="${day}">${day}</option>`;
      }).join('');

      // è¨­å®šé¸ä¸­çš„æ—¥æœŸ
      if (selectedDay && days.some(r => r.date.slice(8, 10) === selectedDay)) {
        daySelect.value = selectedDay;
      } else {
        // é è¨­é¸ç¬¬ä¸€å¤©ï¼ˆè©²æœˆæœ€æ–°ï¼‰
        daySelect.value = days[0].date.slice(8, 10);
      }
    }

    // å¡«å……æœˆä»½é¸å–®
    async function populateSelect() {
      const reports = await detectReports();
      reportsList = reports;

      if (reports.length === 0) {
        monthSelect.innerHTML = '<option value="">ç„¡å¯ç”¨å ±å‘Š</option>';
        daySelect.innerHTML = '<option value=""></option>';
        updateNavButtons();
        return;
      }

      // æŒ‰æœˆä»½åˆ†çµ„
      groupedByMonth = {};
      reports.forEach(r => {
        const month = r.date.slice(0, 7); // "YYYY-MM"
        if (!groupedByMonth[month]) groupedByMonth[month] = [];
        groupedByMonth[month].push(r);
      });

      // å¡«å……æœˆä»½é¸å–®ï¼ˆé™åºï¼šæœ€æ–°åœ¨å‰ï¼‰
      const months = Object.keys(groupedByMonth).sort((a, b) => b.localeCompare(a));
      monthSelect.innerHTML = months.map(month =>
        `<option value="${month}">${month}</option>`
      ).join('');

      // æª¢æŸ¥ URL åƒæ•¸
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get('file');

      if (fileParam && reports.some(r => r.filename === fileParam)) {
        // å¾ filename è§£ææœˆä»½å’Œæ—¥æœŸ
        const match = fileParam.match(/^(\d{4}-\d{2})-(\d{2})-news-report$/);
        if (match) {
          const [, month, day] = match;
          monthSelect.value = month;
          populateDaySelect(month, day);
          loadReport(fileParam);
        }
      } else if (reports.length > 0) {
        // é è¨­è¼‰å…¥æœ€æ–°å ±å‘Š
        monthSelect.value = months[0];
        populateDaySelect(months[0]);
        loadReport(reports[0].filename);
      }

      updateNavButtons();
    }

    // è¼‰å…¥ä¸¦æ¸²æŸ“å ±å‘Š
    async function loadReport(filename) {
      if (!filename) return;

      // æ›´æ–° URLï¼ˆä¸é‡æ–°è¼‰å…¥é é¢ï¼‰
      const url = new URL(window.location);
      url.searchParams.set('file', filename);
      window.history.pushState({}, '', url);

      // é¡¯ç¤ºè¼‰å…¥ä¸­
      main.innerHTML = `
        <div class="loading">
          <div class="spinner"></div>
          <p>è¼‰å…¥ä¸­...</p>
        </div>
      `;

      try {
        const response = await fetch(`${filename}.md` + cacheBuster);

        if (!response.ok) {
          throw new Error(`æª”æ¡ˆä¸å­˜åœ¨: ${filename}.md`);
        }

        let markdown = await response.text();

        // ç§»é™¤å ±å‘Šæ¨™é ­çš„ã€Œç”Ÿæˆè€—æ™‚ã€å’Œã€Œæ—©åœè§¸ç™¼ã€è¡Œ
        markdown = markdown
          .split('\n')
          .filter(line => !line.match(/^>\s*(ç”Ÿæˆè€—æ™‚|æ—©åœè§¸ç™¼)/))
          .join('\n');

        const html = marked.parse(markdown);

        main.innerHTML = `<article class="content">${html}</article>`;

        // æ²å‹•åˆ°é ‚éƒ¨
        window.scrollTo({ top: 0, behavior: 'smooth' });

      } catch (error) {
        main.innerHTML = `
          <div class="error">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
            </svg>
            <p>${error.message}</p>
          </div>
        `;
      }
    }

    // æ›´æ–°å°èˆªæŒ‰éˆ•ç‹€æ…‹
    // reportsList æŒ‰æ—¥æœŸé™åºï¼š[æœ€æ–°, ..., æœ€èˆŠ]
    // â† (prev) å¾€èˆŠ = index å¢åŠ ï¼Œâ†’ (next) å¾€æ–° = index æ¸›å°‘
    function updateNavButtons() {
      const currentFilename = getCurrentFilename();
      const currentIndex = reportsList.findIndex(r => r.filename === currentFilename);
      prevBtn.disabled = currentIndex < 0 || currentIndex >= reportsList.length - 1; // å·²æ˜¯æœ€èˆŠ
      nextBtn.disabled = currentIndex <= 0; // å·²æ˜¯æœ€æ–°
    }

    // å‰å¾Œå°èˆªï¼ˆæ”¯æ´è·¨æœˆï¼‰
    function navigateReport(direction) {
      const currentFilename = getCurrentFilename();
      const currentIndex = reportsList.findIndex(r => r.filename === currentFilename);
      const newIndex = currentIndex + direction;

      if (newIndex >= 0 && newIndex < reportsList.length) {
        const newReport = reportsList[newIndex];
        const newMonth = newReport.date.slice(0, 7);
        const newDay = newReport.date.slice(8, 10);

        // è‹¥è·¨æœˆï¼Œæ›´æ–°æœˆä»½é¸å–®ä¸¦é‡æ–°å¡«å……æ—¥æœŸ
        if (newMonth !== monthSelect.value) {
          monthSelect.value = newMonth;
          populateDaySelect(newMonth, newDay);
        } else {
          daySelect.value = newDay;
        }

        loadReport(newReport.filename);
        updateNavButtons();
      }
    }

    // äº‹ä»¶ç›£è½
    monthSelect.addEventListener('change', (e) => {
      const month = e.target.value;
      populateDaySelect(month);
      const filename = getCurrentFilename();
      loadReport(filename);
      updateNavButtons();
    });

    daySelect.addEventListener('change', () => {
      const filename = getCurrentFilename();
      loadReport(filename);
      updateNavButtons();
    });

    prevBtn.addEventListener('click', () => navigateReport(1));  // å¾€èˆŠ = index +1
    nextBtn.addEventListener('click', () => navigateReport(-1)); // å¾€æ–° = index -1

    // è™•ç†ç€è¦½å™¨å‰é€²/å¾Œé€€
    window.addEventListener('popstate', () => {
      const params = new URLSearchParams(window.location.search);
      const fileParam = params.get('file');
      if (fileParam) {
        const match = fileParam.match(/^(\d{4}-\d{2})-(\d{2})-news-report$/);
        if (match) {
          const [, month, day] = match;
          monthSelect.value = month;
          populateDaySelect(month, day);
          loadReport(fileParam);
          updateNavButtons();
        }
      }
    });

    // åˆå§‹åŒ–
    populateSelect();

    // ========== TTS åŠŸèƒ½ ==========

    // TTS å…ƒç´ 
    const playAllBtn = document.getElementById('play-all-btn');
    const playAllIcon = document.getElementById('play-all-icon');
    const autoPlayCheckbox = document.getElementById('auto-play-checkbox');
    const ttsSettingsBtn = document.getElementById('tts-settings-btn');
    const ttsStatusDot = document.getElementById('tts-status-dot');
    const ttsStatusText = document.getElementById('tts-status-text');

    // Modal å…ƒç´ 
    const ttsModal = document.getElementById('tts-settings-modal');
    const modalCloseBtn = document.getElementById('modal-close-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');
    const modalSaveBtn = document.getElementById('modal-save-btn');
    const ttsEngineSelect = document.getElementById('tts-engine-select');
    const azureSettings = document.getElementById('azure-settings');
    const azureRegionSettings = document.getElementById('azure-region-settings');
    const azureProxySettings = document.getElementById('azure-proxy-settings');
    const azureKeyInput = document.getElementById('azure-key-input');
    const azureRegionInput = document.getElementById('azure-region-input');
    const azureProxyInput = document.getElementById('azure-proxy-input');
    const googleSettings = document.getElementById('google-settings');
    const googleKeyInput = document.getElementById('google-key-input');
    const geminiSettings = document.getElementById('gemini-settings');
    const geminiVoiceSettings = document.getElementById('gemini-voice-settings');
    const geminiKeyInput = document.getElementById('gemini-key-input');
    const geminiVoiceSelect = document.getElementById('gemini-voice-select');
    const fishSettings = document.getElementById('fish-settings');
    const fishVoiceSettings = document.getElementById('fish-voice-settings');
    const fishProxySettings = document.getElementById('fish-proxy-settings');
    const fishKeyInput = document.getElementById('fish-key-input');
    const fishVoiceInput = document.getElementById('fish-voice-input');
    const fishProxyInput = document.getElementById('fish-proxy-input');
    const speechRateSelect = document.getElementById('speech-rate-select');
    const testTtsBtn = document.getElementById('test-tts-btn');
    const engineHint = document.getElementById('engine-hint');

    // TTS ç‹€æ…‹
    let ttsConfig = {
      engine: 'azure',
      azureKey: '',
      azureRegion: 'eastasia',
      azureProxy: 'https://azure-tts.twampd.workers.dev',
      googleKey: '',
      geminiKey: '',
      geminiVoice: 'Kore',
      fishKey: '',
      fishVoice: '',
      fishProxy: 'https://fish-tts.twampd.workers.dev',
      rate: 1
    };
    let isPlayingAll = false;
    let currentPlayingIndex = -1;
    let currentAudio = null;
    let currentUtterance = null;

    // è¼‰å…¥è¨­å®š
    function loadTtsConfig() {
      const saved = localStorage.getItem('ttsConfig');
      if (saved) {
        try {
          ttsConfig = { ...ttsConfig, ...JSON.parse(saved) };
        } catch (e) {
          console.warn('è¼‰å…¥ TTS è¨­å®šå¤±æ•—', e);
        }
      }
      autoPlayCheckbox.checked = localStorage.getItem('autoPlay') === 'true';
      updateTtsStatus();
    }

    // å„²å­˜è¨­å®š
    function saveTtsConfig() {
      localStorage.setItem('ttsConfig', JSON.stringify(ttsConfig));
    }

    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    function updateTtsStatus() {
      if (ttsConfig.engine === 'azure' && (ttsConfig.azureKey || ttsConfig.azureProxy)) {
        ttsStatusDot.className = 'tts-status-dot azure';
        ttsStatusText.textContent = 'Azure TTS';
      } else if (ttsConfig.engine === 'google' && ttsConfig.googleKey) {
        ttsStatusDot.className = 'tts-status-dot google';
        ttsStatusText.textContent = 'Google TTS';
      } else if (ttsConfig.engine === 'gemini' && ttsConfig.geminiKey) {
        ttsStatusDot.className = 'tts-status-dot gemini';
        ttsStatusText.textContent = 'Gemini TTS';
      } else if (ttsConfig.engine === 'fish' && ttsConfig.fishKey) {
        ttsStatusDot.className = 'tts-status-dot fish';
        ttsStatusText.textContent = 'Fish Audio';
      } else {
        ttsStatusDot.className = 'tts-status-dot web';
        ttsStatusText.textContent = 'Web Speech';
      }
    }

    // Web Speech API TTS
    function webSpeechTTS(text) {
      return new Promise((resolve, reject) => {
        if (!('speechSynthesis' in window)) {
          reject(new Error('ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API'));
          return;
        }

        // å–æ¶ˆä¹‹å‰çš„æ’­æ”¾
        speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = ttsConfig.rate;

        // å˜—è©¦é¸æ“‡å°ç£èªéŸ³
        const voices = speechSynthesis.getVoices();
        const twVoice = voices.find(v =>
          v.lang === 'zh-TW' ||
          v.name.includes('Taiwan') ||
          v.name.includes('å°ç£') ||
          v.name.includes('åœ‹èª')
        );
        if (twVoice) {
          utterance.voice = twVoice;
        }

        currentUtterance = utterance;

        utterance.onend = () => {
          currentUtterance = null;
          resolve();
        };

        utterance.onerror = (event) => {
          currentUtterance = null;
          if (event.error !== 'canceled') {
            reject(new Error(event.error));
          } else {
            resolve();
          }
        };

        speechSynthesis.speak(utterance);
      });
    }

    // Azure TTS
    async function azureTTS(text) {
      // SSML æ ¼å¼
      const ssml = `
        <speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xml:lang='zh-TW'>
          <voice name='zh-TW-HsiaoChenNeural'>
            <prosody rate='${ttsConfig.rate}'>
              ${text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
            </prosody>
          </voice>
        </speak>
      `;

      let response;
      if (ttsConfig.azureProxy) {
        // ä½¿ç”¨ä»£ç†ï¼ˆä»£ç†ä¼ºæœå™¨ç®¡ç† API Keyï¼‰
        response = await fetch(ttsConfig.azureProxy, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/ssml+xml'
          },
          body: ssml
        });
      } else {
        // ç›´æ¥å‘¼å« Azureï¼ˆéœ€è¦ API Keyï¼‰
        const endpoint = `https://${ttsConfig.azureRegion}.tts.speech.microsoft.com/cognitiveservices/v1`;
        response = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Ocp-Apim-Subscription-Key': ttsConfig.azureKey,
            'Content-Type': 'application/ssml+xml',
            'X-Microsoft-OutputFormat': 'audio-16khz-128kbitrate-mono-mp3'
          },
          body: ssml
        });
      }

      if (!response.ok) {
        throw new Error(`Azure TTS éŒ¯èª¤: ${response.status}`);
      }

      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = (e) => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('éŸ³è¨Šæ’­æ”¾å¤±æ•—'));
        };

        audio.play().catch(reject);
      });
    }

    // Google Cloud TTS
    async function googleTTS(text) {
      const endpoint = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${ttsConfig.googleKey}`;

      // å°‡èªé€Ÿè½‰æ›ç‚º Google æ ¼å¼ï¼ˆ0.25 åˆ° 4.0ï¼‰
      const speakingRate = ttsConfig.rate;

      const requestBody = {
        input: { text: text },
        voice: {
          languageCode: 'cmn-TW',
          name: 'cmn-TW-Wavenet-A',  // å°ç£åœ‹èªå¥³è²
          ssmlGender: 'FEMALE'
        },
        audioConfig: {
          audioEncoding: 'MP3',
          speakingRate: speakingRate,
          pitch: 0
        }
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(`Google TTS éŒ¯èª¤: ${response.status} - ${error.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
      }

      const data = await response.json();
      const audioContent = data.audioContent;

      // Base64 è§£ç¢¼ä¸¦æ’­æ”¾
      const audioBlob = await fetch(`data:audio/mp3;base64,${audioContent}`).then(r => r.blob());
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = (e) => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('éŸ³è¨Šæ’­æ”¾å¤±æ•—'));
        };

        audio.play().catch(reject);
      });
    }

    // å»ºç«‹ WAV æ¨™é ­ï¼ˆç”¨æ–¼å°‡ PCM è½‰æ›ç‚º WAVï¼‰
    function createWavHeader(dataLength, sampleRate, numChannels, bitsPerSample) {
      const byteRate = sampleRate * numChannels * bitsPerSample / 8;
      const blockAlign = numChannels * bitsPerSample / 8;
      const buffer = new ArrayBuffer(44);
      const view = new DataView(buffer);

      // RIFF chunk descriptor
      writeString(view, 0, 'RIFF');
      view.setUint32(4, 36 + dataLength, true);
      writeString(view, 8, 'WAVE');

      // fmt sub-chunk
      writeString(view, 12, 'fmt ');
      view.setUint32(16, 16, true); // Subchunk1Size
      view.setUint16(20, 1, true);  // AudioFormat (PCM)
      view.setUint16(22, numChannels, true);
      view.setUint32(24, sampleRate, true);
      view.setUint32(28, byteRate, true);
      view.setUint16(32, blockAlign, true);
      view.setUint16(34, bitsPerSample, true);

      // data sub-chunk
      writeString(view, 36, 'data');
      view.setUint32(40, dataLength, true);

      return new Uint8Array(buffer);

      function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
          view.setUint8(offset + i, string.charCodeAt(i));
        }
      }
    }

    // Gemini TTS
    async function geminiTTS(text) {
      const model = 'gemini-2.5-flash-preview-tts';
      const endpoint = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${ttsConfig.geminiKey}`;

      // Gemini TTS éœ€è¦ã€Œèªªã€æˆ–ã€Œæœ—è®€ã€æŒ‡ä»¤
      const requestBody = {
        contents: [{
          parts: [{ text: `è«‹æœ—è®€ï¼š${text}` }]
        }],
        generationConfig: {
          responseModalities: ['AUDIO'],
          speechConfig: {
            voiceConfig: {
              prebuiltVoiceConfig: {
                voiceName: ttsConfig.geminiVoice
              }
            }
          }
        }
      };

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(`Gemini TTS éŒ¯èª¤: ${response.status} - ${error.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
      }

      const data = await response.json();

      // å¾å›æ‡‰ä¸­æå–éŸ³è¨Šè³‡æ–™
      const audioData = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
      const mimeType = data.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType;

      if (!audioData) {
        throw new Error('Gemini TTS æœªè¿”å›éŸ³è¨Šè³‡æ–™: ' + JSON.stringify(data.error || data));
      }

      // è§£ç¢¼ Base64 éŸ³è¨Šè³‡æ–™
      const binaryString = atob(audioData);
      const bytes = new Uint8Array(binaryString.length);
      for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
      }

      // å¦‚æœæ˜¯ PCM æ ¼å¼ï¼ˆaudio/L16ï¼‰ï¼Œéœ€è¦åŠ ä¸Š WAV æ¨™é ­
      let audioBlob;
      if (mimeType && mimeType.includes('L16')) {
        // PCM 16-bit, 24000Hz, mono -> WAV
        const wavHeader = createWavHeader(bytes.length, 24000, 1, 16);
        const wavData = new Uint8Array(wavHeader.length + bytes.length);
        wavData.set(wavHeader, 0);
        wavData.set(bytes, wavHeader.length);
        audioBlob = new Blob([wavData], { type: 'audio/wav' });
      } else {
        // å…¶ä»–æ ¼å¼ç›´æ¥ä½¿ç”¨
        audioBlob = new Blob([bytes], { type: mimeType || 'audio/mp3' });
      }
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;

        // èª¿æ•´æ’­æ”¾é€Ÿåº¦
        audio.playbackRate = ttsConfig.rate;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = (e) => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('éŸ³è¨Šæ’­æ”¾å¤±æ•—'));
        };

        audio.play().catch(reject);
      });
    }

    // Fish Audio TTS
    async function fishAudioTTS(text) {
      if (!ttsConfig.fishKey) {
        throw new Error('è«‹å…ˆè¨­å®š Fish Audio API Key');
      }

      // ä½¿ç”¨ä»£ç† URL æˆ–åŸå§‹ endpointï¼ˆåŸå§‹æœƒé‡åˆ° CORS é™åˆ¶ï¼‰
      const endpoint = ttsConfig.fishProxy || 'https://api.fish.audio/v1/tts';

      const requestBody = {
        text: text,
        format: 'mp3',
        mp3_bitrate: 128,
        normalize: true,
        latency: 'normal'
      };

      // å¦‚æœæœ‰æŒ‡å®šèªéŸ³æ¨¡å‹ ID
      if (ttsConfig.fishVoice) {
        requestBody.reference_id = ttsConfig.fishVoice;
      }

      const response = await fetch(endpoint, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${ttsConfig.fishKey}`,
          'Content-Type': 'application/json',
          'model': 's1'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        const error = await response.json().catch(() => ({}));
        throw new Error(`Fish Audio éŒ¯èª¤: ${response.status} - ${error.message || 'æœªçŸ¥éŒ¯èª¤'}`);
      }

      // Fish Audio ç›´æ¥è¿”å›éŸ³è¨Šè³‡æ–™
      const audioBlob = await response.blob();
      const audioUrl = URL.createObjectURL(audioBlob);

      return new Promise((resolve, reject) => {
        const audio = new Audio(audioUrl);
        currentAudio = audio;
        audio.playbackRate = ttsConfig.rate;

        audio.onended = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          resolve();
        };

        audio.onerror = () => {
          URL.revokeObjectURL(audioUrl);
          currentAudio = null;
          reject(new Error('Fish Audio æ’­æ”¾å¤±æ•—'));
        };

        audio.play().catch(reject);
      });
    }

    // çµ±ä¸€ TTS ä»‹é¢
    async function speak(text) {
      if (ttsConfig.engine === 'azure' && (ttsConfig.azureKey || ttsConfig.azureProxy)) {
        try {
          await azureTTS(text);
        } catch (e) {
          console.warn('Azure TTS å¤±æ•—ï¼Œé™ç´šè‡³ Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else if (ttsConfig.engine === 'google' && ttsConfig.googleKey) {
        try {
          await googleTTS(text);
        } catch (e) {
          console.warn('Google TTS å¤±æ•—ï¼Œé™ç´šè‡³ Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else if (ttsConfig.engine === 'gemini' && ttsConfig.geminiKey) {
        try {
          await geminiTTS(text);
        } catch (e) {
          console.warn('Gemini TTS å¤±æ•—ï¼Œé™ç´šè‡³ Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else if (ttsConfig.engine === 'fish' && ttsConfig.fishKey) {
        try {
          await fishAudioTTS(text);
        } catch (e) {
          console.warn('Fish Audio å¤±æ•—ï¼Œé™ç´šè‡³ Web Speech API', e);
          await webSpeechTTS(text);
        }
      } else {
        await webSpeechTTS(text);
      }
    }

    // åœæ­¢æ’­æ”¾
    function stopSpeaking() {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
      }
      if (currentUtterance) {
        speechSynthesis.cancel();
        currentUtterance = null;
      }
    }

    // æå–æ–°èå…§å®¹ï¼ˆæ’é™¤ä¾†æºé€£çµã€é—œéµè©ã€è©•åˆ†ï¼‰
    function extractNewsContent(section) {
      const h2 = section.querySelector('h2');
      if (!h2) return '';

      // å–å¾—æ¨™é¡Œï¼ˆæ’é™¤æ’­æ”¾æŒ‰éˆ•æ–‡å­—ï¼‰
      const titleText = h2.textContent.replace(/^\d+\.\s*/, '').trim();

      // å°‹æ‰¾æ‘˜è¦ï¼ˆé€šå¸¸æ˜¯ strong é–‹é ­çš„é …ç›®ï¼‰
      let summary = '';
      const items = section.querySelectorAll('li');
      for (const item of items) {
        const strong = item.querySelector('strong');
        if (strong && (strong.textContent.includes('æ‘˜è¦') || strong.textContent.includes('æ¦‚è¿°'))) {
          summary = item.textContent.replace(/^[^ï¼š:]+[ï¼š:]/, '').trim();
          break;
        }
      }

      // å°‹æ‰¾è¦é»ï¼ˆæœ‰åºåˆ—è¡¨ï¼‰
      const points = [];
      const ol = section.querySelector('ol');
      if (ol) {
        const lis = ol.querySelectorAll('li');
        lis.forEach((li, i) => {
          if (i < 3) { // æœ€å¤š 3 é»
            points.push(li.textContent.trim());
          }
        });
      }

      // çµ„åˆæ’­æ”¾å…§å®¹
      let content = titleText;
      if (summary) {
        content += `ã€‚${summary}`;
      }
      if (points.length > 0) {
        content += `ã€‚é‡é»å¦‚ä¸‹ï¼š${points.join('ã€‚')}`;
      }

      return content;
    }

    // å–å¾—æ‰€æœ‰æ–°èå€å¡Š
    function getNewsSections() {
      const content = document.querySelector('.content');
      if (!content) return [];

      // æ‰¾åˆ°æ‰€æœ‰ h2 æ¨™é¡Œå°æ‡‰çš„å€å¡Š
      const sections = [];
      const h2s = content.querySelectorAll('h2');

      h2s.forEach((h2, index) => {
        // å»ºç«‹ä¸€å€‹è™›æ“¬å€å¡Šï¼šå¾ h2 åˆ°ä¸‹ä¸€å€‹ h2ï¼ˆæˆ–æ–‡ç« çµå°¾ï¼‰
        const section = {
          h2: h2,
          element: h2.parentElement,
          index: index
        };

        // æ‰¾åˆ°è©² h2 å¾Œçš„æ‰€æœ‰å…§å®¹ç›´åˆ°ä¸‹ä¸€å€‹ h2
        let sibling = h2.nextElementSibling;
        const contentElements = [h2];

        while (sibling && sibling.tagName !== 'H2') {
          contentElements.push(sibling);
          sibling = sibling.nextElementSibling;
        }

        section.contentElements = contentElements;
        sections.push(section);
      });

      return sections;
    }

    // ç‚º h2 æ¨™é¡Œæ·»åŠ æ’­æ”¾æŒ‰éˆ•
    function addPlayButtons() {
      const sections = getNewsSections();

      sections.forEach((section, index) => {
        const h2 = section.h2;

        // æª¢æŸ¥æ˜¯å¦å·²æœ‰æŒ‰éˆ•
        if (h2.querySelector('.item-play-btn')) return;

        const btn = document.createElement('button');
        btn.className = 'item-play-btn';
        btn.setAttribute('aria-label', 'æ’­æ”¾æ­¤æ–°è');
        btn.setAttribute('data-index', index);
        btn.innerHTML = `
          <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="stop-icon" style="display:none" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
            <rect x="6" y="6" width="12" height="12"/>
          </svg>
        `;

        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          playItem(index);
        });

        h2.appendChild(btn);
      });
    }

    // æ’­æ”¾å–®ä¸€é …ç›®
    async function playItem(index) {
      const sections = getNewsSections();
      if (index < 0 || index >= sections.length) return;

      // å¦‚æœæ­£åœ¨æ’­æ”¾æ­¤é …ç›®ï¼Œå‰‡åœæ­¢
      if (currentPlayingIndex === index) {
        stopPlaying();
        return;
      }

      // åœæ­¢ä¹‹å‰çš„æ’­æ”¾
      stopPlaying();

      const section = sections[index];
      currentPlayingIndex = index;

      // æ›´æ–° UI
      updatePlayingUI(index, true);

      try {
        // å»ºç«‹è‡¨æ™‚å®¹å™¨æå–å…§å®¹
        const tempDiv = document.createElement('div');
        section.contentElements.forEach(el => {
          tempDiv.appendChild(el.cloneNode(true));
        });

        const content = extractNewsContent(tempDiv);
        if (content) {
          await speak(content);
        }
      } catch (e) {
        console.error('æ’­æ”¾å¤±æ•—', e);
      } finally {
        // æ¢å¾© UI
        updatePlayingUI(index, false);
        currentPlayingIndex = -1;
      }
    }

    // åœæ­¢æ’­æ”¾
    function stopPlaying() {
      stopSpeaking();
      isPlayingAll = false;
      updatePlayAllButton(false);

      if (currentPlayingIndex >= 0) {
        updatePlayingUI(currentPlayingIndex, false);
        currentPlayingIndex = -1;
      }
    }

    // æ›´æ–°æ’­æ”¾ä¸­ UI
    function updatePlayingUI(index, isPlaying) {
      const sections = getNewsSections();
      if (index < 0 || index >= sections.length) return;

      const section = sections[index];
      const btn = section.h2.querySelector('.item-play-btn');

      if (btn) {
        const playIcon = btn.querySelector('.play-icon');
        const stopIcon = btn.querySelector('.stop-icon');

        if (isPlaying) {
          btn.classList.add('playing');
          if (playIcon) playIcon.style.display = 'none';
          if (stopIcon) stopIcon.style.display = 'block';
        } else {
          btn.classList.remove('playing');
          if (playIcon) playIcon.style.display = 'block';
          if (stopIcon) stopIcon.style.display = 'none';
        }
      }

      // é«˜äº®ç•¶å‰å€å¡Š
      section.contentElements.forEach(el => {
        if (el.tagName === 'H2') {
          const parent = el.closest('article') || el.parentElement;
          // ç‚ºè©²å€å¡Šæ·»åŠ æ¨£å¼ï¼ˆç°¡åŒ–è™•ç†ï¼‰
        }
      });
    }

    // æ›´æ–°å…¨éƒ¨æ’­æ”¾æŒ‰éˆ•
    function updatePlayAllButton(isPlaying) {
      if (isPlaying) {
        playAllBtn.classList.add('playing');
        playAllIcon.innerHTML = '<rect x="6" y="6" width="12" height="12"/>';
        playAllBtn.querySelector('span').textContent = 'åœæ­¢æ’­æ”¾';
      } else {
        playAllBtn.classList.remove('playing');
        playAllIcon.innerHTML = '<path d="M8 5v14l11-7z"/>';
        playAllBtn.querySelector('span').textContent = 'å…¨éƒ¨æ’­æ”¾';
      }
    }

    // å…¨éƒ¨æ’­æ”¾
    async function playAll() {
      if (isPlayingAll) {
        stopPlaying();
        return;
      }

      const sections = getNewsSections();
      if (sections.length === 0) return;

      isPlayingAll = true;
      updatePlayAllButton(true);

      for (let i = 0; i < sections.length; i++) {
        if (!isPlayingAll) break;

        currentPlayingIndex = i;
        updatePlayingUI(i, true);

        try {
          const tempDiv = document.createElement('div');
          sections[i].contentElements.forEach(el => {
            tempDiv.appendChild(el.cloneNode(true));
          });

          const content = extractNewsContent(tempDiv);
          if (content) {
            await speak(content);
          }
        } catch (e) {
          console.error('æ’­æ”¾å¤±æ•—', e);
        } finally {
          updatePlayingUI(i, false);
        }

        // çŸ­æš«åœé “
        if (isPlayingAll && i < sections.length - 1) {
          await new Promise(resolve => setTimeout(resolve, 500));
        }
      }

      isPlayingAll = false;
      currentPlayingIndex = -1;
      updatePlayAllButton(false);
    }

    // äº‹ä»¶ç›£è½
    playAllBtn.addEventListener('click', playAll);

    autoPlayCheckbox.addEventListener('change', (e) => {
      localStorage.setItem('autoPlay', e.target.checked);
    });

    // Modal æ§åˆ¶
    function openModal() {
      // è¼‰å…¥ç•¶å‰è¨­å®šåˆ°è¡¨å–®
      ttsEngineSelect.value = ttsConfig.engine;
      azureKeyInput.value = ttsConfig.azureKey;
      azureRegionInput.value = ttsConfig.azureRegion;
      azureProxyInput.value = ttsConfig.azureProxy;
      googleKeyInput.value = ttsConfig.googleKey;
      geminiKeyInput.value = ttsConfig.geminiKey;
      geminiVoiceSelect.value = ttsConfig.geminiVoice;
      fishKeyInput.value = ttsConfig.fishKey;
      fishVoiceInput.value = ttsConfig.fishVoice;
      fishProxyInput.value = ttsConfig.fishProxy;
      speechRateSelect.value = ttsConfig.rate.toString();

      // é¡¯ç¤º/éš±è—è¨­å®šå€å¡Š
      updateEngineSettings(ttsConfig.engine);

      ttsModal.classList.add('open');
    }

    function updateEngineSettings(engine) {
      const showAzure = engine === 'azure';
      const showGoogle = engine === 'google';
      const showGemini = engine === 'gemini';
      const showFish = engine === 'fish';
      azureSettings.style.display = showAzure ? 'block' : 'none';
      azureRegionSettings.style.display = showAzure ? 'block' : 'none';
      azureProxySettings.style.display = showAzure ? 'block' : 'none';
      googleSettings.style.display = showGoogle ? 'block' : 'none';
      geminiSettings.style.display = showGemini ? 'block' : 'none';
      geminiVoiceSettings.style.display = showGemini ? 'block' : 'none';
      fishSettings.style.display = showFish ? 'block' : 'none';
      fishVoiceSettings.style.display = showFish ? 'block' : 'none';
      fishProxySettings.style.display = showFish ? 'block' : 'none';

      // æ›´æ–°å¼•æ“èªªæ˜
      const hints = {
        web: 'Web Speech API å…è²»ä¸”ç„¡éœ€è¨­å®šï¼Œå“è³ªè¦–ç€è¦½å™¨è€Œå®š',
        azure: 'Azure TTS é«˜å“è³ªï¼Œå…è²» 50 è¬å­—/æœˆ',
        google: 'Google Cloud TTS å…è²» 100 è¬å­—/æœˆ',
        gemini: 'Gemini TTS æœ€è‡ªç„¶ï¼Œå¯ç”¨æç¤ºæ§åˆ¶èªèª¿',
        fish: 'Fish Audio å°ç£è…”æ¨¡å‹ï¼Œè‡ªç„¶ç”Ÿæ´»æ„Ÿ'
      };
      engineHint.textContent = hints[engine] || '';
    }

    function closeModal() {
      ttsModal.classList.remove('open');
    }

    ttsSettingsBtn.addEventListener('click', openModal);
    modalCloseBtn.addEventListener('click', closeModal);
    modalCancelBtn.addEventListener('click', closeModal);

    ttsModal.addEventListener('click', (e) => {
      if (e.target === ttsModal) {
        closeModal();
      }
    });

    ttsEngineSelect.addEventListener('change', (e) => {
      updateEngineSettings(e.target.value);
    });

    testTtsBtn.addEventListener('click', async () => {
      const originalText = testTtsBtn.textContent;
      testTtsBtn.textContent = 'æ’­æ”¾ä¸­...';
      testTtsBtn.disabled = true;

      // è‡¨æ™‚æ‡‰ç”¨è¨­å®š
      const tempConfig = { ...ttsConfig };
      ttsConfig.engine = ttsEngineSelect.value;
      ttsConfig.azureKey = azureKeyInput.value;
      ttsConfig.azureRegion = azureRegionInput.value;
      ttsConfig.azureProxy = azureProxyInput.value;
      ttsConfig.googleKey = googleKeyInput.value;
      ttsConfig.geminiKey = geminiKeyInput.value;
      ttsConfig.geminiVoice = geminiVoiceSelect.value;
      ttsConfig.fishKey = fishKeyInput.value;
      ttsConfig.fishVoice = fishVoiceInput.value;
      ttsConfig.fishProxy = fishProxyInput.value;
      ttsConfig.rate = parseFloat(speechRateSelect.value);

      try {
        await speak('æ‚¨å¥½ï¼Œé€™æ˜¯èªéŸ³æ¸¬è©¦ã€‚æ­¡è¿æ”¶è½æ¯æ—¥ AI æ–°èç²¾é¸ã€‚');
      } catch (e) {
        console.error('æ¸¬è©¦å¤±æ•—', e);
        alert('èªéŸ³æ¸¬è©¦å¤±æ•—ï¼š' + e.message);
      } finally {
        // æ¢å¾©åŸè¨­å®šï¼ˆå¦‚æœä½¿ç”¨è€…æ²’æœ‰å„²å­˜ï¼‰
        ttsConfig = tempConfig;
        testTtsBtn.textContent = originalText;
        testTtsBtn.disabled = false;
      }
    });

    modalSaveBtn.addEventListener('click', () => {
      ttsConfig.engine = ttsEngineSelect.value;
      ttsConfig.azureKey = azureKeyInput.value;
      ttsConfig.azureRegion = azureRegionInput.value;
      ttsConfig.azureProxy = azureProxyInput.value;
      ttsConfig.googleKey = googleKeyInput.value;
      ttsConfig.geminiKey = geminiKeyInput.value;
      ttsConfig.geminiVoice = geminiVoiceSelect.value;
      ttsConfig.fishKey = fishKeyInput.value;
      ttsConfig.fishVoice = fishVoiceInput.value;
      ttsConfig.fishProxy = fishProxyInput.value;
      ttsConfig.rate = parseFloat(speechRateSelect.value);

      saveTtsConfig();
      updateTtsStatus();
      closeModal();
    });

    // è‡ªå‹•æ’­æ”¾è¦†è“‹å±¤
    const autoplayOverlay = document.getElementById('autoplay-overlay');
    let pendingAutoplay = false;

    function showAutoplayOverlay() {
      pendingAutoplay = true;
      autoplayOverlay.classList.add('show');
    }

    function hideAutoplayOverlay() {
      autoplayOverlay.classList.remove('show');
    }

    autoplayOverlay.addEventListener('click', () => {
      hideAutoplayOverlay();
      if (pendingAutoplay) {
        pendingAutoplay = false;
        playAll();
      }
    });

    // ESC éµé—œé–‰è¦†è“‹å±¤
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && pendingAutoplay) {
        hideAutoplayOverlay();
        pendingAutoplay = false;
      }
    });

    // ç›£è½å ±å‘Šè¼‰å…¥å®Œæˆ
    const originalLoadReport = loadReport;
    loadReport = async function(filename) {
      await originalLoadReport(filename);

      // å ±å‘Šè¼‰å…¥å¾Œæ·»åŠ æ’­æ”¾æŒ‰éˆ•
      setTimeout(() => {
        addPlayButtons();

        // è‡ªå‹•æ’­æ”¾ï¼šé¡¯ç¤ºè¦†è“‹å±¤ç­‰å¾…ç”¨æˆ¶é»æ“Š
        if (autoPlayCheckbox.checked && !isPlayingAll) {
          setTimeout(() => showAutoplayOverlay(), 500);
        }
      }, 100);
    };

    // åˆå§‹åŒ– TTS
    loadTtsConfig();

    // ç¢ºä¿èªéŸ³åˆ—è¡¨å·²è¼‰å…¥ï¼ˆWeb Speech API éœ€è¦ï¼‰
    if ('speechSynthesis' in window) {
      speechSynthesis.getVoices();
      speechSynthesis.addEventListener('voiceschanged', () => {
        speechSynthesis.getVoices();
      });
    }

    // é é¢å¯è¦‹æ€§è®ŠåŒ–æ™‚æš«åœ
    document.addEventListener('visibilitychange', () => {
      if (document.hidden && isPlayingAll) {
        // å¯é¸ï¼šé é¢éš±è—æ™‚æš«åœæ’­æ”¾
        // stopPlaying();
      }
    });
  </script>
</body>
</html>
